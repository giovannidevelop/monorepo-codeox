server {
  listen 80;
  server_name _;

  # DNS del bridge Docker
  resolver 127.0.0.11 ipv6=off valid=10s;

  # ---------- Upstreams ----------
  set $auth     http://subox-be-ms-authentication:7000;
  set $products http://subox-be-ms-product:7003;
  set $clientes http://cliente-service:5000;
  set $mail     http://subox-be-ms-mail:9099;
  set $pay      http://payment-core:5007;
  set $vsapi    http://vendedor-supremo-webhook:5008;

  # ---------- Health ----------
  location = /healthz {
    add_header Content-Type text/plain;
    return 200 "ok\n";
  }

  # ---------- Swagger UI vía gateway en /docs ----------
  # Normaliza /docs -> /docs/
  location = /docs {
    return 302 /docs/;
  }

  # Strip del prefijo /docs/ y proxear al root del contenedor swagger-ui
  location ^~ /docs/ {
    rewrite ^/docs/(.*)$ /$1 break;
    proxy_pass http://swagger-ui:8080/;   # <- con slash final para usar la ruta reescrita
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    add_header X-From-Gateway "api-gateway" always;
  }

  location = /api/auth/api-docs     { proxy_pass $auth/api-docs; }
  location = /api/products/api-docs  { proxy_pass $products/api-docs; }
  location = /api/clientes/api-docs  { proxy_pass $clientes/api-docs; }
  location = /api/payments/api-docs    { proxy_pass $pay/api-docs; }     # tu caso
  location = /api/payments/v3/api-docs { proxy_pass $pay/v3/api-docs; }


  # ---------- Proxies (API) ----------
  # Estos microservicios YA esperan /api/... -> no reescribir
  location ^~ /api/auth/ {
    proxy_pass $auth;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    add_header X-From-Gateway "api-gateway" always;
  }

  location ^~ /api/clientes/ {
    proxy_pass $clientes;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    add_header X-From-Gateway "api-gateway" always;
  }

  location ^~ /api/mail/ {
    proxy_pass $mail;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    add_header X-From-Gateway "api-gateway" always;
  }

  location ^~ /api/payments/ {
    proxy_pass $pay;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    add_header X-From-Gateway "api-gateway" always;
  }

  # products NO expone /api/...; controladores en /productos, /categorias, etc.
  # aquí SÍ quitamos /api/products/
  location ^~ /api/products/ {
    rewrite ^/api/products/(.*)$ /$1 break;
    proxy_pass $products;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    add_header X-From-Gateway "api-gateway" always;
  }

  # Webhook: micro espera /webhook/whatsapp -> quitamos prefijo bonito
  location ^~ /api/webhooks/vendedor-supremo/ {
    rewrite ^/api/webhooks/vendedor-supremo/(.*)$ /$1 break;
    proxy_pass $vsapi;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    add_header X-From-Gateway "api-gateway" always;
  }
}
