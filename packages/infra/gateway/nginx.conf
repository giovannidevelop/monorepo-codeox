# Usa el DNS embebido de Docker y resuelve en runtime
resolver 127.0.0.11 ipv6=off valid=10s;

# Variables para cada upstream (evita resolución en el arranque)
set $auth_upstream      subox-be-ms-authentication:8080;
set $product_upstream   subox-be-ms-product:8080;
set $client_upstream    cliente-service:8080;
set $mail_upstream      subox-be-ms-mail:8080;
set $payments_upstream  payment-core:5007;
set $webhooks_upstream  vendedor-supremo-webhook:8080;

map $http_upgrade $connection_upgrade { default upgrade; '' close; }

server {
  listen 8080;
  server_name _;

  # Auth
  location /api/auth/ {
    proxy_pass http://$auth_upstream/;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $remote_addr;
  }

  # Productos
  location /api/products/ {
    proxy_pass http://$product_upstream/;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $remote_addr;
  }

  # Clientes
  location /api/clientes/ {
    proxy_pass http://$client_upstream/;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $remote_addr;
  }

  # Imágenes
  location /api/images/ {
    proxy_pass http://$image_upstream/;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $remote_addr;
  }

  # Mail
  location /api/mail/ {
    proxy_pass http://$mail_upstream/;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $remote_addr;
  }

  # Pagos
  location /api/payments/ {
    proxy_pass http://$payments_upstream/;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $remote_addr;
  }

  # Webhooks
  location /api/webhooks/ {
    proxy_pass http://$webhooks_upstream/;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $remote_addr;
  }
}
